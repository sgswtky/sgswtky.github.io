---
title: "Goè¨€èªã§wasmå‹•ã‹ã—ã¦ã¿ãŸ"
date: 2018-07-22T19:38:54+09:00
draft: false
categories: ["Go"]
tags: ["WebAssembly"]
description: Golangã§wasmã‚’ã©ã‚“ãªã‚‚ã‚“ãªã®ã‹å‹•ã‹ã—ã¦ã¿ãŸã€‚
---
wasmã¨ã¯ä½•ã‹ã‚’èª¿ã¹ã¦ã¿ã¦ã€Goã§ãƒ–ãƒ©ã‚¦ã‚¶ã§å‹•ã‹ã—ã¦ã¿ã¾ã—ãŸã€‚

## WebAssembly ã¨ã¯ä½•ãªã®ã‹

- ç•¥ã—ã¦wasmã€‚
- ãƒ¡ã‚¸ãƒ£ãƒ¼4ãƒ–ãƒ©ã‚¦ã‚¶ï¼ˆChromeã€Edgeã€Firefoxã€Safariï¼‰ã§ã‚µãƒãƒ¼ãƒˆ
- ãƒ–ãƒ©ã‚¦ã‚¶ä¸Šã§Goç­‰ã§ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã•ã‚ŒãŸãƒã‚¤ãƒŠãƒªãŒå‹•ã‹ã›ã‚‹ğŸ‘
- åŒã˜Web APIï¼ˆJavascriptãŒæ“ä½œã§ãã‚‹é ˜åŸŸã€ãƒ—ãƒ­ã‚»ã‚¹ã®VM?ï¼‰ã§Jsã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®å‘¼ã³å‡ºã—ã‚„ã€ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã›ã‚‹æ„Ÿã˜ã€‚
- ãƒã‚¤ãƒ†ã‚£ãƒ–ã«è¿‘ã„ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã§å‹•ä½œã™ã‚‹

### WebAssemblyç™»å ´ã®èƒŒæ™¯

- ã‚³ãƒ¼ãƒ‰ã®ã‚µã‚¤ã‚ºãŒå¤§ãã„å ´åˆã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã®ã‚³ã‚¹ãƒˆãŒé«˜ã„ã¨ã„ã†å•é¡Œã«å¯¾å¿œã™ã‚‹ãŸã‚ã€WebAssemblyãŒç™»å ´ã€‚
- æ™®é€šã«Webã‚„ã£ã¦ã‚‹ã¨æ„Ÿã˜ãªã„ã¨æ€ã†ã‘ã©ã€ãƒ–ãƒ©ã‚¦ã‚¶ä¸Šã§å‹•ä½œã™ã‚‹ã‚²ãƒ¼ãƒ ãƒ»3Dã‚’ä½¿ã£ãŸã‚µãƒ¼ãƒ“ã‚¹ã®Jsã‚³ãƒ¼ãƒ‰ã¨ã‹ã¯æ•°åMBã‚ã‚‹ã‚‰ã—ã„ã®ã§ã‚µã‚¤ã‚ºå•é¡Œã¯ç„¡è¦–ã§ããªã„ã€‚
![wasmé›°å›²æ°—ã‚¤ãƒ©ã‚¹ãƒˆ](/images/go-wasm-illust.png)

### WebAssemblyã‚’ä½¿ãˆã‚‹è¨€èª

- LLVMã«å¤‰æ›ã§ãã‚‹è¨€èªãªã‚‰å‹•ãã‚‰ã—ã„ã€‚ï¼ˆCãƒ»C++ãƒ»Objective-Cãƒ»Rustãƒ»Go?ï¼‰
- kripken/emscripten ã¨ã„ã†ãƒ„ãƒ¼ãƒ«ã§ LLVM to wasmãŒå¯èƒ½

å°†æ¥çš„ã«ã¯ã€

- Jsã‹ã‚‰wasmã«ç½®ãæ›ã‚ã‚‹äº‹ã¯ãªã„
- Javascriptã‚’è£œå®Œã™ã‚‹ã ã‘

## WebAssembly ã‚’ Golangã§è§¦ã‚‹ã«ã¯

wasmã¯ `go1.11` ç³»ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‹ã‚‰ä½¿ç”¨å¯èƒ½ã€‚

`go1.11` ç³»ã¯æ­£å¼ã«ãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã¦ã„ãªã„ã®ã§ã€betaç‰ˆã¨ãªã‚‹ã€‚

åƒ•ã¯ `go1.11beta2` ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦è©¦ã—ã¾ã—ãŸã€‚

â€»go1.11æœªæº€ã ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™

```failure.bash
> GOARCH=wasm GOOS=js go build -o test.wasm main.go
cmd/go: unsupported GOOS/GOARCH pair js/wasm
```

å®Ÿéš›ã«è§¦ã£ã¦ã¿ã‚‹ã«ã‚ãŸã‚Šã€golangã®wasmã‚’ãƒ–ãƒ©ã‚¦ã‚¶ä¸Šã§å®Ÿéš›ã«å‹•ã‹ã›ã‚‹ã“ã¡ã‚‰ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚’ã‚„ã£ã¦ã¿ãŸ https://blog.gopheracademy.com/advent-2017/go-wasm/

{{< post-ads >}}

## å®Ÿéš›ã«è©¦ã—ã«å‹•ã‹ã—ã¦ã¿ãŸ

Goã§ãƒ“ãƒ«ãƒ‰ã—ãŸã‚³ãƒ¼ãƒ‰ãŒãƒ–ãƒ©ã‚¦ã‚¶ã§å‹•ã„ã¦æ„Ÿå‹•ã€‚

wasmãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒƒãƒ€ã® Content-TypeãŒ `application/wasm` ã¨ãªã£ã¦ã„ãŸã€‚

ä»¥ä¸‹ã®ã‚ˆã†ãªgoroutineã®ã‚³ãƒ¼ãƒ‰ã‚‚wasmã§å‹•ã‹ã—ã¦ã¿ãŸã‚‰ã¡ã‚ƒã‚“ã¨å‹•ã„ãŸã€‚

```main.go
package main

import (
	"fmt"
	"time"
	"sync"
	"math/rand"
)

func f(s string, wg *sync.WaitGroup) {
	for i := 0; i < 3; i++ {
		time.Sleep(time.Second * 1)
		fmt.Printf("%s%d: %d\n", s, i+1, rand.Int())
	}
	wg.Done()
}

func main() {
	wg := new(sync.WaitGroup)
	for i := 0; i < 3; i++ {
		wg.Add(1)
		go f("test", wg)
	}
	wg.Wait()
}

```

ä»¥ä¸‹ã¯å®Ÿéš›ã«å‹•ã‹ã—ãŸæ§˜å­ã€‚
Content-TypeãŒ `wasm` ã¨ãªã‚‹æ‰€ã€`fmt.Printlf` ãŒ console.logã«ä¸¦åˆ—ã§å‡ºåŠ›ã•ã‚Œã¦ã„ã‚‹æ‰€ãŒã‚ã‹ã‚‹ã€‚
![å®Ÿéš›ã«wasmã§å‹•ã‹ã—ãŸæ§˜å­](/images/go-wasm-run.gif)

ãƒã‚¤ãƒ†ã‚£ãƒ–ã«è¿‘ã„ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¨ã„ã†æ‰€ã«ã¤ã„ã¦ã¯ã¡ã‚ƒã‚“ã¨æ¤œè¨¼ã—ã¦ãªã„ã®ã§ã‚ã¾ã‚Šã‚ã‹ã‚‰ãªã‹ã£ãŸã€‚

Golangã¯å‡¦ç†ã®é€Ÿã•ã«å®šè©•ãŒã‚ã‚‹ã®ã§ã€ã‚³ãƒ¬ã²ã¨ã¤è¦šãˆã‚‹ã ã‘ã§ã§ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã‚‚ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚‚é€Ÿåº¦å‡ºã›ã‚‹æ„Ÿã˜ã®ãƒ¢ãƒãŒä½œã‚Œã‚‹ã‚ˆã†ã«ä»Šå¾Œãªã‚‹ã®ã‹ãªã¨æ€ã£ãŸã€‚

## Golang ã§ã® WebAssemblyã¯å®Ÿéš›ä»Šå¾Œã§ä½¿ãˆã‚‹ã‚‚ã®ãªã®ã‹

ãƒ¡ãƒªãƒƒãƒˆãƒ»ãƒ‡ãƒ¡ãƒªãƒƒãƒˆã‚’è¦‹ã‚‹æ„Ÿã˜ã€ä»Šã®æ‰€æ´»ã‹ã›ãã†ãªåˆ†é‡ã§ã„ãã¨ã‚²ãƒ¼ãƒ ãƒ»3Dæç”»ãƒ»é‡ã„å‡¦ç†ã™ã‚‹ç³»ã®æ‰€ãã‚‰ã„â€¦ï¼Ÿã¨ã„ã†æ‰€æ„Ÿã§ã—ãŸã€‚

ãã®ãŸã‚Webã‚·ã‚¹ãƒ†ãƒ å±‹ã¨ã—ã¦ã¯ä»Šã®æ‰€ã€ã¾ã ä½¿ã†æ‰€ã¯ã—ã£ã‹ã‚Šæƒ³åƒã§ãã¾ã›ã‚“ã§ã—ãŸã€‚
ãƒã‚¤ãƒ†ã‚£ãƒ–ã«è¿‘ã„ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã§å‹•ã„ãŸã¨ã—ã¦ã‚‚ã€ãƒ•ãƒ­ãƒ³ãƒˆã§ãã‚“ãªé‡ã„äº‹ã‚´ãƒªã‚´ãƒªã«ã‚„ã‚‰ãªã„ã‚“ã˜ã‚ƒãªã„ã‹ãªãƒ¼ã¨ã„ã†å°è±¡ã§ã™ã€‚

ãŸã ã€ã‚ã‚‹ç¨‹åº¦ã®æ£²ã¿åˆ†ã‘ãŒã§ãã‚Œã°é–‹ç™ºè€…ã«ã¨ã£ã¦ã®ãƒ¡ãƒªãƒƒãƒˆã¯ã‚ã‚Šãã†ã ãªã¨æ€ã„ã¾ã—ãŸã€‚
ä¾‹ãˆã°ã€JS + wasm(Go) ã§ã€ä¸»ãªå‡¦ç†ã¯Goã«æ›¸ã„ã¦JSã¯DOMå‘¨ã‚Šã ã‘ã‚’æ‹…å½“ã™ã‚‹ã¿ãŸã„ãªæ„Ÿã˜ã§è²¬ä»»ç¯„å›²ã‚’åˆ†ã‘ã¦ã€ãªã‚‹ã¹ãã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã¨åŒã˜è¨€èªã§æ›¸ãã¿ãŸã„ãªã€‚

å‘¨è¾ºã®ã‚¨ã‚³ã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã£ã¦ã§ãã‚‹ã“ã¨ãŒå¢—ãˆã¦ã„ãã¨æ€ã†ã®ã§ã€ä»Šå¾Œã®ç™ºå±•ã«æ³¨ç›®ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

## å‚è€ƒã«ã—ãŸã‚µã‚¤ãƒˆ

https://developer.mozilla.org/ja/docs/WebAssembly/Concepts

