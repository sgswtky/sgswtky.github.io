
<!DOCTYPE html>
<html lang="ja-jp">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Hugo 0.42.2" />


<title>Digdagの require オペレータで別のワークフローを複数回起動させる - 壁は登るためにある</title>
<meta property="og:title" content="Digdagの require オペレータで別のワークフローを複数回起動させる - 壁は登るためにある">



  






<link rel="icon" href="https://sgswtky.github.io/images/" type="image/x-icon"/>
<link rel="stylesheet" href="https://sgswtky.github.io/css/main.css" media="all">
<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Merriweather:400|Lato:400,400italic,700">


  </head>
  <body>
    <div class="wrapper">
      <header class="header">
        <nav class="nav">
  <a href="https://sgswtky.github.io/" class="nav-logo" style="text-decoration: none; color: #000000; font-size: 18px">
    <img src="https://sgswtky.github.io/images/logo.png" 
         width="50" 
         height="50" 
         alt="logo"
         style="float:left;"
    >
    <div style="white-space: nowrap; font-family: 'Lato', sans-serif; height:50px; display:flex; align-items: center; padding-left: 10px">壁は登るためにある</div>
  </a>
  <ul class="nav-links">
    
    <li><a href="/about/">About</a></li>
    
    <li><a href="/">Blog</a></li>
    
    <li><a href="https://github.com/sgswtky">GitHub</a></li>
    
    <li><a href="https://twitter.com/sgswtky">Twitter</a></li>
    
  </ul>
</nav>

      </header>


<main class="content" role="main">
  <article class="article">
    
    <span class="article-duration">3 min read</span>
    

    <h1 class="article-title">Digdagの require オペレータで別のワークフローを複数回起動させる</h1>

    
    <span class="article-date">July 26, 2019</span>
    
    <div class="article-content">
      

<h2 id="digdag">digdag</h2>

<p><a href="https://www.digdag.io/">https://www.digdag.io/</a></p>

<p>TreasureDataが開発するオープンソースのジョブスケジューラ</p>

<p>個人的に、Jenkinsと比較してコード管理・ログの扱いを厳重に管理できる好印象なプロダクト</p>

<h2 id="今回の内容">今回の内容</h2>

<p>通常、 <code>require</code> オペレータを使用すると <code>session_time</code> の関係で別のワークフローを複数回起動する事はできないけど、 <code>session_time</code> を動的に変更して無理矢理複数回起動させる。</p>

<p><code>call</code> を使えば同じ事ができるけど、 <code>ignore_failure</code> を使いたかったので、 <code>require</code> で動くようにしてみた。</p>

<p>現時点で調べてみた感じ同様の内容は特に記事になってなかったので、せっかくなので書いてみる。</p>

<p>（<code>session_time</code> と <code>require</code> であえてできないようにしてる事を無理矢理やってる感じがあるので、もし本番に適用する場合は自己責任で…）</p>

<h3 id="requireを普通に使ったパターン">requireを普通に使ったパターン</h3>

<p><code>parent.diglk</code></p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-parent.dig" data-lang="parent.dig">timezone: UTC

+setup:
  echo&gt;: start ${session_time}

+pypy:
  py&gt;: task.EXAMPLE.getParam

+repeat:
  for_each&gt;:
    param: ${params}
  _do:
    require&gt;: child
    params:
      param: ${param}</code></pre></div>
<p><code>child.dig</code></p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-child.dig" data-lang="child.dig">timezone: UTC

+setup:
  echo&gt;: ${moment(session_time).utc().format(&#39;YYYY-MM-DD HH:mm:ss Z&#39;)}

+child_job:
  sh&gt;: sleep 5 &amp;&amp; echo ${param}</code></pre></div>
<p><code>task/__init__.py</code></p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-task/__init__.py" data-lang="task/__init__.py"><span style="color:#999;font-style:italic"># coding=utf-8</span>
<span style="color:#6ab825;font-weight:bold">import</span> <span style="color:#447fcf">json</span>
<span style="color:#6ab825;font-weight:bold">import</span> <span style="color:#447fcf">digdag</span>

<span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#447fcf">EXAMPLE</span>(<span style="color:#24909d">object</span>):
  <span style="color:#6ab825;font-weight:bold">def</span> <span style="color:#447fcf">getParam</span>(self):
    <span style="color:#24909d">list</span> = [<span style="color:#ed9d13">&#34;e&#34;</span>, <span style="color:#ed9d13">&#34;x&#34;</span>, <span style="color:#ed9d13">&#34;a&#34;</span>, <span style="color:#ed9d13">&#34;m&#34;</span>, <span style="color:#ed9d13">&#34;p&#34;</span>, <span style="color:#ed9d13">&#34;l&#34;</span>, <span style="color:#ed9d13">&#34;e&#34;</span>]
    digdag.env.store({<span style="color:#ed9d13">&#39;params&#39;</span>: json.dumps(<span style="color:#24909d">list</span>)})</code></pre></div>
<p>requireで <code>child.dig</code> を呼び出すも、複数回呼ばれる事はありません。</p>

<p>WebUIで見るとこうなる。</p>

<p><img src="/images/digdag-require-reuse-normal-require.png" alt="digdagのWebUI" /></p>

<h3 id="今回の内容-requireを無理矢理複数回呼び出してみる">[今回の内容] requireを無理矢理複数回呼び出してみる</h3>

<p>内容は比較的単純で、呼び出す <code>require</code> 全てに違う <code>session_time</code> を指定している。</p>

<p><code>require</code> で <code>session_time</code> 指定せずに起動した場合、親の <code>session_time</code> を使うため、２度目の起動ができない。なのでループ毎に違う <code>session_time</code> を指定するだけで全てのループで <code>require</code> が起動する。</p>

<p><code>reuse_parent.dig</code></p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-reuse_parent.dig" data-lang="reuse_parent.dig">timezone: UTC

+setup:
  echo&gt;: start ${session_time}

+pypy:
  py&gt;: task.EXAMPLE.getParamNum

+repeat:
  for_each&gt;:
    param: ${params}
  _do:
    require&gt;: reuse_child
    ## ここで加算して全てのループで違う値にする事で全て起動する
    session_time: ${moment(session_time).add(param.no, &#39;s&#39;).format(&#39;YYYY-MM-DDTHH:mm:ssZ&#39;)}
    params:
      param: ${param.value}</code></pre></div>
<p>↓こちらは特に変更無いです</p>

<p><code>reuse_child.dig</code></p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-reuse_child.dig" data-lang="reuse_child.dig">timezone: UTC

+setup:
  echo&gt;: ${moment(session_time).utc().format(&#39;YYYY-MM-DD HH:mm:ss Z&#39;)}

+child_job:
  sh&gt;: sleep 5 &amp;&amp; echo ${param}</code></pre></div>
<p><code>task/__init__.py</code></p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-task/__init__.py" data-lang="task/__init__.py"><span style="color:#999;font-style:italic"># coding=utf-8</span>
<span style="color:#6ab825;font-weight:bold">import</span> <span style="color:#447fcf">json</span>
<span style="color:#6ab825;font-weight:bold">import</span> <span style="color:#447fcf">digdag</span>

<span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#447fcf">EXAMPLE</span>(<span style="color:#24909d">object</span>):
  <span style="color:#6ab825;font-weight:bold">def</span> <span style="color:#447fcf">getParamNum</span>(self):
    <span style="color:#24909d">list</span> = [<span style="color:#ed9d13">&#34;e&#34;</span>, <span style="color:#ed9d13">&#34;x&#34;</span>, <span style="color:#ed9d13">&#34;a&#34;</span>, <span style="color:#ed9d13">&#34;m&#34;</span>, <span style="color:#ed9d13">&#34;p&#34;</span>, <span style="color:#ed9d13">&#34;l&#34;</span>, <span style="color:#ed9d13">&#34;e&#34;</span>]
    result = []
    <span style="color:#6ab825;font-weight:bold">for</span> i <span style="color:#6ab825;font-weight:bold">in</span> <span style="color:#24909d">range</span>(<span style="color:#24909d">len</span>(<span style="color:#24909d">list</span>)):
      result.append({<span style="color:#ed9d13">&#39;no&#39;</span>: i, <span style="color:#ed9d13">&#39;value&#39;</span>: <span style="color:#24909d">list</span>[i]})
    digdag.env.store({<span style="color:#ed9d13">&#39;params&#39;</span>: json.dumps(result)})</code></pre></div>
<p>結果、このように <code>require</code> を使用していますが順番に実行されます。</p>

<p><img src="/images/digdag-require-reuse-require.png" alt="digdagのWebUI" /></p>

<h4 id="パラメータで付与している理由">パラメータで付与している理由</h4>

<p>現在時刻を使って加算する方法などもあると思うけど、うまく動作しなかった。</p>

<p>動的なパラメータを <code>moment</code> で加算するとうまく動かなかったので、 python側で生成し、digdagが扱う際には静的になってるパラメータを使う事で全ての <code>require</code> が動作した。</p>

<h4 id="オススメしないパターン">オススメしないパターン</h4>

<p>なんとなく触っていて、 <code>子ワークフローを共有する</code> というのは避けたほうが良いと思いました。</p>

<p>子を複数の親が使うと、片親が使ってる時、もう片親も使い始めて <code>session_time</code> がかぶった時にどちらかがスキップされる挙動になると思います。</p>

<h2 id="requireオペレーターを使った時の挙動">requireオペレーターを使った時の挙動</h2>

<p>普通に使った時の挙動などはこちらのQiitaに詳しくまとめられていました。ので、こちらなどを参考にすると良いと思います。</p>

<p><a href="https://qiita.com/shiozaki/items/b3aaff926b7b601b4f86">https://qiita.com/shiozaki/items/b3aaff926b7b601b4f86</a></p>

<h2 id="最後に">最後に</h2>

<p>書かなきゃと思ってたけどずっとサボってて 2019年初記事が7月下旬になってしまった。</p>

<p>今回のコードをこちらに上げてありますので機会がありましたらお試しください。</p>

<p><a href="https://github.com/sgswtky/example-digdag-require-reuse">https://github.com/sgswtky/example-digdag-require-reuse</a></p>

    </div>
    <div class="addthis_inline_share_toolbox"></div>

  </article>
  

</main>

      <footer class="footer">
        <ul class="footer-links">
          <li>
            <a href="https://sgswtky.github.io/index.xml" type="application/rss+xml" target="_blank">RSS feed</a>
          </li>
          <li>
            <a href="https://gohugo.io/" class="footer-links-kudos">Made with <img src="https://sgswtky.github.io/images/hugo-logo.png" width="22" height="22"></a>
          </li>
        </ul>
      </footer>

    </div>

    
    <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5b4b66137935d0b4" async></script>

  </body>
</html>

