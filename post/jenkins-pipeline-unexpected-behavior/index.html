
<!DOCTYPE html>
<html lang="ja-jp">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Hugo 0.68.3" />


<title>Jenkins Pipeline でGroovyを書いてたら期待しない動きをした - 壁は登るためにある</title>
<meta property="og:title" content="Jenkins Pipeline でGroovyを書いてたら期待しない動きをした - 壁は登るためにある">



  






<link rel="icon" href="https://sgswtky.github.io/images/" type="image/x-icon"/>
<link rel="stylesheet" href="https://sgswtky.github.io/css/main.css" media="all">
<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Merriweather:400|Lato:400,400italic,700">


  </head>
  <body>
    <div class="wrapper">
      <header class="header">
        <nav class="nav">
  <a href="https://sgswtky.github.io/" class="nav-logo" style="text-decoration: none; color: #000000; font-size: 18px">
    <img src="https://sgswtky.github.io/images/logo.png" 
         width="50" 
         height="50" 
         alt="logo"
         style="float:left;"
    >
    <div style="white-space: nowrap; font-family: 'Lato', sans-serif; height:50px; display:flex; align-items: center; padding-left: 10px">壁は登るためにある</div>
  </a>
  <ul class="nav-links">
    
    <li><a href="/about/">About</a></li>
    
    <li><a href="/">Blog</a></li>
    
    <li><a href="https://github.com/sgswtky">GitHub</a></li>
    
    <li><a href="https://twitter.com/sgswtky">Twitter</a></li>
    
  </ul>
</nav>

      </header>


<main class="content" role="main">
  <article class="article">
    
    <span class="article-duration">2 min read</span>
    

    <h1 class="article-title">Jenkins Pipeline でGroovyを書いてたら期待しない動きをした</h1>

    
    <span class="article-date">July 17, 2018</span>
    
    <div class="article-content">
      <p>先日から古い <code>Jenkins2</code> のジョブをメンテする仕事をしていて、Pipelineで Groovyを書いてたら特定のパターンでは動くけどそれ以外だと動かないという事情に遭遇した。</p>
<p>やりたかったことは、パイプラインAから、ジョブAを並列で2つ起動させたかった。
色々調べたけど結局わからなくて、バージョンアップしたら治った話。</p>
<h2 id="事象">事象</h2>
<h3 id="動かないコード">動かないコード</h3>
<p>コードは極々単純で以下のようなコード。</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-pipeline.groovy" data-lang="pipeline.groovy">node(<span style="color:#ed9d13">&#34;master&#34;</span>){
  <span style="color:#6ab825;font-weight:bold">def</span> tasks = [:]
  <span style="color:#6ab825;font-weight:bold">for</span> (i = <span style="color:#3677a9">0</span>; i &lt; <span style="color:#3677a9">2</span>; i++) {
    tasks[i.<span style="color:#bbb">toString</span>()] = {
        build job: <span style="color:#ed9d13">&#34;Job_A&#34;</span>
      }
  }
  parallel tasks
}
</code></pre></div><p>このコードを実行したら通常であれば ジョブA が２つ実行されるはず。しかし以下のように1つしか Job_Aが実行されなかった。</p>
<pre><code class="language-jenkins.log" data-lang="jenkins.log">Started by timer
[Pipeline] node
Running on master in /var/lib/jenkins/workspace/Pipeline_A
[Pipeline] {
[Pipeline] parallel
[Pipeline] [0] { (Branch: 0)
[Pipeline] [1] { (Branch: 1)
[Pipeline] [0] stage
[Pipeline] [0] { (branch_2)
[Pipeline] [1] stage
[Pipeline] [1] { (branch_2)
[Pipeline] [0] build (Building Job_A)
[0] Scheduling project: Job_A
[Pipeline] [1] build (Building Job_A)
[1] Scheduling project: Job_A
[0] Starting building: Job_A #4
// ↑ここで Job_A が ビルド番号4で起動しているのがわかるが、起動しているのは #4 だけ。
[Pipeline] [0] }
[Pipeline] [1] }
[Pipeline] [0] // stage
[Pipeline] [1] // stage
[Pipeline] [0] }
[Pipeline] [1] }
[Pipeline] // parallel
[Pipeline] }
[Pipeline] // node
[Pipeline] End of Pipeline
Finished: SUCCESS
</code></pre><h3 id="何故か動くコード">何故か動くコード</h3>
<p>以下のコードは期待する動きをした。</p>
<p>でもサーバー名を渡してるパラメータを廃止したかったため、 <code>params.size()</code> でなく、普通に forで回数分ループするコード（記事上部のコード）にしたかったが動かない。</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-pipeline.groovy" data-lang="pipeline.groovy">node(<span style="color:#ed9d13">&#34;master&#34;</span>){
  <span style="color:#6ab825;font-weight:bold">def</span> params = [<span style="color:#ed9d13">&#34;server-01&#34;</span>, <span style="color:#ed9d13">&#34;server-02&#34;</span>]
  <span style="color:#6ab825;font-weight:bold">def</span> tasks = [:]

  <span style="color:#6ab825;font-weight:bold">for</span> (i = <span style="color:#3677a9">0</span>; i &lt; params.<span style="color:#bbb">size</span>(); i++) {
    <span style="color:#6ab825;font-weight:bold">def</span> param = params[i]
    tasks[param] = {
      param: {
        build job: <span style="color:#ed9d13">&#34;Job_A&#34;</span>, parameters: [<span style="color:#6ab825;font-weight:bold">new</span> StringParameterValue(<span style="color:#ed9d13">&#34;HOST&#34;</span>, param)]
      }
    }
  }
  print(tasks)
  parallel tasks
}
</code></pre></div><p>これの原因が全くわからなくて、バージョンアップした所正常に動くようになった。</p>
<h2 id="バージョン情報">バージョン情報</h2>
<p>バージョンアップの際に対象のプラグインだけでなく全てのプラグインのバージョンアップを行ってしまいました。</p>
<p>そのため下記に記載するプラグイン以外もバージョンアップしちゃってます。。。</p>
<table>
<thead>
<tr>
<th>対象</th>
<th>旧バージョン</th>
<th>新バージョン</th>
</tr>
</thead>
<tbody>
<tr>
<td>Jenkins</td>
<td>v2.30</td>
<td>v2.132</td>
</tr>
<tr>
<td>Pipeline（プラグイン）</td>
<td>2.5</td>
<td>2.6</td>
</tr>
</tbody>
</table>
<p>（Jenkinsのマイナーバージョンが100くらい上がってますね💦）</p>
<h2 id="まとめ">まとめ</h2>
<p>結構長い間（といっても合計3時間くらい）苦しんでたので解決できてよかった。
Jenkinsのバージョンアップだけは動かなくなる可能性がある（と勝手にそう思い込んでた）のでなるべくしたくなかったけど行って治ってよかった。</p>
<p>毎日定時でAMIをまるごとバックアップを取ってからか、バージョンアップ等のオペレーションの敷居がある程度低く、バックアップは大事だと再認識した。</p>

    </div>
    <div class="addthis_inline_share_toolbox"></div>

  </article>
  

</main>

      <footer class="footer">
        <ul class="footer-links">
          <li>
            <a href="https://sgswtky.github.io/index.xml" type="application/rss+xml" target="_blank">RSS feed</a>
          </li>
          <li>
            <a href="https://gohugo.io/" class="footer-links-kudos">Made with <img src="https://sgswtky.github.io/images/hugo-logo.png" width="22" height="22"></a>
          </li>
        </ul>
      </footer>

    </div>

    
    <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5b4b66137935d0b4" async></script>

  </body>
</html>

